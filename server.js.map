{"version":3,"sources":["server.jsx"],"names":[],"mappings":"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","file":"server.js","sourcesContent":["/** @jsx h */\r\n\r\nimport { serve } from \"https://deno.land/std@0.121.0/http/server.ts\";\r\nimport { h, Helmet, renderSSR } from \"nano-jsx\";\r\nimport dayjsEsm from \"dayjs/esm\";\r\nimport dayjsPluginRelativeTime from \"dayjs/plugin/relativeTime\";\r\nimport { Package } from \"./lib/package.js\";\r\nimport { Home } from \"./lib/home.js\";\r\nimport { pageServingHeaders, renderMarkdownContent } from \"./utils.js\";\r\nimport { FEATURED_PACKAGES } from \"./lib/featured-packages-list.js\";\r\nimport { features, parseURL } from \"./lib/package-quality-check.js\";\r\n\r\nconst staticResources = {\r\n  \"/style.css\": { path: \"./style.css\", contentType: \"text/css; charset=utf-8\" },\r\n  \"/dom-main.js\": {\r\n    path: \"./lib/dom-main.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/dom-main.js.map\": {\r\n    path: \"./lib/dom-main.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/statehash.js\": {\r\n    path: \"./lib/statehash.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/statehash.js.map\": {\r\n    path: \"./lib/statehash.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/header.js\": {\r\n    path: \"./lib/header.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/header.js.map\": {\r\n    path: \"./lib/header.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/exports.js\": {\r\n    path: \"./lib/exports.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/exports.js.map\": {\r\n    path: \"./lib/exports.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/hero.js\": {\r\n    path: \"./lib/hero.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/hero.js.map\": {\r\n    path: \"./lib/hero.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/generate-statehash.js\": {\r\n    path: \"./lib/generate-statehash.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/generate-statehash.js.map\": {\r\n    path: \"./lib/generate-statehash.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/logo.js\": {\r\n    path: \"./lib/logo.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/logo.js.map\": {\r\n    path: \"./lib/logo.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/search.js\": {\r\n    path: \"./lib/search.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/search.js.map\": {\r\n    path: \"./lib/search.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/nav.js\": {\r\n    path: \"./lib/nav.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/nav.js.map\": {\r\n    path: \"./lib/nav.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/importmap-generator.js\": {\r\n    path: \"./lib/importmap-generator.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/importmap-generator.js.map\": {\r\n    path: \"./lib/importmap-generator.js.map\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/imports-hash-store.js\": {\r\n    path: \"./lib/imports-hash-store.js\",\r\n    contentType: \"application/javascript; charset=utf-8\",\r\n  },\r\n  \"/icon-add.svg\": {\r\n    path: \"./images/icon-add.svg\",\r\n    contentType: \"image/svg+xml; charset=utf-8\",\r\n  },\r\n  \"/icon-check.svg\": {\r\n    path: \"./images/icon-check.svg\",\r\n    contentType: \"image/svg+xml; charset=utf-8\",\r\n  },\r\n  \"/icon-typescript-logo.svg\": {\r\n    path: \"./images/icon-typescript-logo.svg\",\r\n    contentType: \"image/svg+xml; charset=utf-8\",\r\n  },\r\n  \"/favicon.ico\": {\r\n    path: \"./favicon.ico\",\r\n    contentType: \"image/vnd.microsoft.icon\",\r\n  },\r\n};\r\n\r\nasync function generateHTML(\r\n  { template, body, head, footer } = { template: \"./lib/shell.html\" },\r\n) {\r\n  const content = await Deno.readTextFile(template);\r\n  const [START, AFTER_HEADER_BEFORE_CONTENT, DOM_SCRIPT, END] = content\r\n    .split(/<!-- __[A-Z]*__ -->/i);\r\n  return [\r\n    START,\r\n    head.join(\"\\n\"),\r\n    AFTER_HEADER_BEFORE_CONTENT,\r\n    body,\r\n    DOM_SCRIPT,\r\n    footer.join(\"\\n\"),\r\n    END,\r\n  ].join(\"\\n\");\r\n}\r\n\r\n/**\r\n * @param {string} path\r\n * @returns {string}\r\n */\r\nfunction removeLeadingSlash(path) {\r\n  if (path.startsWith(\"/\")) {\r\n    return path.slice(1);\r\n  }\r\n  return path;\r\n}\r\n\r\n/**\r\n * @param {string} path\r\n * @returns {string}\r\n */\r\nfunction removeTrailingSlash(path) {\r\n  if (path.endsWith(\"/\")) {\r\n    return path.slice(0, -1);\r\n  }\r\n  return path;\r\n}\r\n\r\n/**\r\n * @param {string} path\r\n * @returns {string}\r\n */\r\nfunction removeSlashes(path) {\r\n  return removeTrailingSlash(removeLeadingSlash(path));\r\n}\r\n\r\nasync function requestHandler(request) {\r\n  try {\r\n    const { pathname, searchParams } = new URL(request.url);\r\n\r\n    const NPM_PROVIDER_URL = \"https://ga.jspm.io/npm:\";\r\n    const npmPackage = searchParams.get(\"q\");\r\n    if (npmPackage) {\r\n      const npmPackageProbe = await fetch(`${NPM_PROVIDER_URL}${npmPackage}`);\r\n      const npmPackageVersion = await npmPackageProbe.text();\r\n\r\n      if (npmPackageVersion) {\r\n        return new Response(npmPackage, {\r\n          status: 302,\r\n          headers: {\r\n            \"Location\": `/package/${npmPackage}@${npmPackageVersion}`,\r\n          },\r\n        });\r\n      }\r\n    }\r\n    const pathSegments = removeSlashes(pathname).split(\"/\");\r\n    const staticResource =\r\n      staticResources[`/${pathSegments[pathSegments.length - 1]}`];\r\n\r\n    if (staticResource) {\r\n      const response = await Deno.readFile(staticResource.path);\r\n\r\n      return new Response(response, {\r\n        headers: { \"content-type\": staticResource.contentType },\r\n      });\r\n    }\r\n\r\n    if (pathname === \"/\") {\r\n      const indexPage = renderSSR(\r\n        <Home packages={FEATURED_PACKAGES} />,\r\n      );\r\n      const { body, head, footer } = Helmet.SSR(indexPage);\r\n      const html = await generateHTML({\r\n        template: \"./lib/shell.html\",\r\n        body,\r\n        head,\r\n        footer,\r\n      });\r\n      return new Response(html, {\r\n        headers: pageServingHeaders,\r\n      });\r\n    }\r\n\r\n    const BASE_PATH = \"/package/\";\r\n    const maybeReadmeFiles = [\"README.md\", \"readme.md\"];\r\n\r\n    if (pathname.startsWith(BASE_PATH)) {\r\n      const [, packageName] = pathname.split(BASE_PATH);\r\n\r\n      if (packageName) {\r\n        const baseURL = `${NPM_PROVIDER_URL}${packageName}`;\r\n        const filesToFetch = [\"package.json\", ...maybeReadmeFiles];\r\n\r\n        const [jspmPackage, READMEFile, readmeFile] = await Promise.all(\r\n          filesToFetch.map((file) => fetch(`${baseURL}/${file}`)),\r\n        );\r\n          const packageJson = await jspmPackage.json();\r\n        const {\r\n          name,\r\n          description,\r\n          keywords,\r\n          version,\r\n          license,\r\n          files,\r\n          exports,\r\n          types,\r\n          type,\r\n          homepage,\r\n          repository,\r\n          bugs\r\n        } = packageJson;\r\n\r\n        const readmeFileContent = await [READMEFile, readmeFile]\r\n          .find(\r\n            (readmeFile) =>\r\n              readmeFile.status === 200 || readmeFile.status === 304,\r\n          )\r\n          .text();\r\n          // https://github.com/npm/registry/blob/master/docs/download-counts.md\r\n        const weeklyDownloadsResponse = await fetch(\r\n          `https://api.npmjs.org/downloads/point/last-week/${name}`,\r\n        );\r\n\r\n        const { downloads } = await weeklyDownloadsResponse.json();\r\n        // https://github.com/npm/registry\r\n        const packageMetaData = await fetch(\r\n          `https://registry.npmjs.org/${name}`,\r\n        );\r\n        const { maintainers, readme, time: { created: createdISO, modified } } = await packageMetaData.json();\r\n\r\n        dayjsEsm.extend(dayjsPluginRelativeTime);\r\n        const updated = dayjsEsm(modified).fromNow();\r\n        const created = dayjsEsm(createdISO).fromNow();\r\n        try {\r\n          // `readme` is preferred here but this content always refers to the latest version\r\n          // hence using it as fallback\r\n          const readmeHTML = renderMarkdownContent(readmeFileContent || readme);\r\n          // https://github.com/jspm/generator.jspm.io/blob/main/src/api.js#L137\r\n          const filteredExport = Object.keys(exports).filter((expt) =>\r\n            !expt.endsWith(\"!cjs\") && !expt.endsWith(\"/\") &&\r\n            expt.indexOf(\"*\") === -1\r\n          ).sort();\r\n\r\n          const links = {\r\n            homepage,\r\n            repository: parseURL(repository),\r\n            issues: parseURL(bugs)\r\n          }\r\n\r\n          const app = renderSSR(\r\n            <Package\r\n              name={name}\r\n              description={description}\r\n              version={version}\r\n              homepage={homepage}\r\n              license={license}\r\n              files={files}\r\n              exports={filteredExport}\r\n              readme={readmeHTML}\r\n              keywords={keywords}\r\n              downloads={downloads}\r\n              created={created}\r\n              updated={updated}\r\n              type={type}\r\n              types={types}\r\n              features={features(packageJson)}\r\n              links={links}\r\n              maintainers={maintainers}\r\n            />,\r\n          );\r\n          const { body, head, footer } = Helmet.SSR(app);\r\n          /* Hack to SSR readme :! */\r\n          const html = await generateHTML({\r\n            template: \"./lib/shell.html\",\r\n            body,\r\n            head,\r\n            footer,\r\n          });\r\n\r\n          return new Response(html, {\r\n            headers: pageServingHeaders,\r\n          });\r\n        } catch (e) {\r\n          console.error(`Failed in generating package-page ${name}@${version}`);\r\n          console.error(e);\r\n          return new Response(\"500\", { status: 500 });\r\n        }\r\n      }\r\n    }\r\n\r\n    return new Response(\"404\", { status: 404 });\r\n  } catch (error) {\r\n    return new Response(error.message || error.toString(), { status: 500 });\r\n  }\r\n}\r\n\r\nif (import.meta?.main) {\r\n  const timestamp = Date.now();\r\n  const humanReadableDateTime = new Intl.DateTimeFormat(\"default\", {\r\n    dateStyle: \"full\",\r\n    timeStyle: \"long\",\r\n  }).format(timestamp);\r\n\r\n  console.log(\"Current Date: \", humanReadableDateTime);\r\n  console.info(`Server Listening on http://localhost:8000`);\r\n\r\n  serve(requestHandler);\r\n}\r\n"]}